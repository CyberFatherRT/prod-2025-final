include:
  - project: pipelines/pipelines
    ref: master
    file:
      - "/jobs/build.yaml"
      - "/jobs/docker.yaml"
      - "/jobs/rules.yaml"

.global-variables:
  variables:
    SSH_USER: "$ENV_SSH_USER"
    SSH_HOST: "$ENV_SSH_HOST"
    SSH_PRIVATE_KEY_BASE64: "$ENV_PRIVATE_KEY_BASE64"

stages:
  - deploy

deploy:
  extends:
    - .ssh
    - .global-variables
    - .rules-merge-or-master
  stage: deploy
  script:
    - ssh $SSH_ADDRESS "cd /home/ubuntu/prod && git pull && docker compose down && docker compose up -d --build"
